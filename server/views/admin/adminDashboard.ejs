<%- include('../partials/header') %>

<div
  style="max-width: 960px; margin: 40px auto; font-family: Arial, sans-serif; color: #222; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
  <h1 style="color: #2c3e50; margin-bottom: 30px; border-bottom: 2px solid #2980b9; padding-bottom: 8px;">
    üéõÔ∏è Welcome to Admin Dashboard
  </h1>

  <% if (users && users.length > 0) { %>
    <h2 style="color: #34495e; margin-bottom: 20px;">üë• User List</h2>
    <div style="overflow-x:auto; background-color: white; border-radius: 6px;">
      <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <thead>
          <tr style="background-color: #2980b9; color: white;">
            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Email</th>
            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Is Subscribed</th>
            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Subscription Expires</th>
            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Time Left</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(user => { %>
            <tr style="border-bottom: 1px solid #ddd;">
              <td style="padding: 12px; border: 1px solid #ddd;">
                <%= user.email %>
              </td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                <%= user.isSubscribed ? '‚úÖ' : '‚ùå' %>
              </td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                <%= user.subscriptionExpires
                  ? new Date(user.subscriptionExpires).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' })
                  : 'N/A' %>
              </td>
              <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                <% if (user.subscriptionExpires) {
                  const expires = new Date(user.subscriptionExpires);
                  const nowIST = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
                  const msLeft = expires - nowIST;
                  if (msLeft > 0) {
                    const days = Math.floor(msLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((msLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                %>
                    <%= `${days} days ${hours} hours left` %>
                  <% } else { %>
                    Expired
                  <% }
                } else { %>
                  -
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <p style="color: #7f8c8d; font-style: italic;">No users found yet.</p>
  <% } %>

  <hr style="margin: 40px 0; border-color: #ddd;" />

  <h2 style="color: #34495e; margin-bottom: 20px;">üì• Users Downloads</h2>
  <% if (users && users.length > 0) { %>
    <% users.forEach(user => { %>
      <% if (user.downloads && user.downloads.length > 0) { %>
        <div
          style="margin-bottom: 30px; padding: 15px; background-color: #f9f9f9; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
          <h3 style="color: #2c3e50; margin-bottom: 12px;">User: <span style="font-weight: 700;"><%= user.email %></span></h3>
          <ul style="list-style: none; padding-left: 0; margin: 0;">
            <% user.downloads
              .sort((a, b) => new Date(b.date) - new Date(a.date))  // Sort descending by date
              .forEach(dl => { %>
              <li
                style="background-color: white; margin-bottom: 8px; padding: 10px 15px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: #34495e;">
                    <%= dl.songId ? dl.songId.title : 'Unknown song' %>
                  </strong>
                  <% if (dl.trackId) { %>
                    <div style="font-size: 0.9em; color: #7f8c8d;">
                      Track: <%= dl.trackId.name %>
                    </div>
                  <% } %>
                </div>
                <small style="color: #7f8c8d; font-size: 0.9em;">
                  <%= new Date(dl.date).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
                </small>
              </li>
            <% }) %>
          </ul>
        </div>
      <% } %>
    <% }) %>
  <% } else { %>
    <p style="color: #7f8c8d; font-style: italic;">No downloads yet.</p>
  <% } %>

  <hr style="margin: 40px 0; border-color: #ddd;" />

  <% if (tracks && tracks.length > 0) { %>
    <ul style="list-style: none; padding: 0;">
      <% tracks.forEach(track => { %>
        <li
          style="background: #f0f0f0; margin-bottom: 12px; padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <!-- <strong>
              <%= track.name %> own music
            </strong> -->
            <br />
            <!-- <small style="color: #7f8c8d; font-size: 0.9em;">
              <%= track.createdAt
                ? new Date(track.createdAt).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
                : 'Date not available' %>
            </small> -->
          </div>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p>No songs available for download yet.</p>
  <% } %>

</div>

<%- include('../partials/footer') %>
